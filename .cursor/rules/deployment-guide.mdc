# ä¸æœªå¥‡é—¨éç”²ç³»ç»Ÿ - éƒ¨ç½²æŒ‡å— (2024ä¼˜åŒ–ç‰ˆ)

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### å¼€å‘ç¯å¢ƒï¼ˆæœ¬åœ°ï¼‰ - æ¨èæ–¹å¼
```bash
# ä½¿ç”¨ç»Ÿä¸€å¯åŠ¨è„šæœ¬
./start-dev.sh install    # å®‰è£…æ‰€æœ‰ä¾èµ–
./start-dev.sh start      # äº¤äº’å¼å¯åŠ¨é€‰æ‹©

# é€‰æ‹©å¯åŠ¨æ¨¡å¼:
# 1) åªå¯åŠ¨åç«¯ (ç«¯å£3001)
# 2) åç«¯ + Vueå‰ç«¯ (ç«¯å£3001 + 5173)
# 3) åç«¯ + Reactå‰ç«¯ (ç«¯å£3001 + 5174)
# 4) å®Œæ•´å¯åŠ¨ (åç«¯ + ä¸¤ä¸ªå‰ç«¯)
# 5) åªå¯åŠ¨Vueå‰ç«¯
# 6) åªå¯åŠ¨Reactå‰ç«¯
```

### æ‰‹åŠ¨å¯åŠ¨æ–¹å¼
```bash
# 1. å¯åŠ¨åç«¯
cd apps/backend
node app.js

# 2. å¯åŠ¨Vueå‰ç«¯ï¼ˆæ–°ç»ˆç«¯ï¼‰
cd apps/frontend-vue
npm run dev
# è®¿é—®: http://localhost:5173

# 3. å¯åŠ¨Reactå‰ç«¯ï¼ˆæ–°ç»ˆç«¯ï¼‰
cd apps/frontend-react
npm run dev
# è®¿é—®: http://localhost:5174
```

## ğŸ”§ åç«¯éƒ¨ç½²æ–¹å¼

### æ–¹å¼ä¸€ï¼šç›´æ¥å¯åŠ¨ [apps/backend/app.js](mdc:apps/backend/app.js)
```bash
cd apps/backend
node app.js                         # å¼€å‘ç¯å¢ƒ
NODE_ENV=production node app.js     # ç”Ÿäº§ç¯å¢ƒ
```

### æ–¹å¼äºŒï¼šä½¿ç”¨åç«¯å¯åŠ¨è„šæœ¬
```bash
# æ³¨æ„ï¼šè¿™äº›è„šæœ¬ä»åœ¨åç«¯ç›®å½•å†…
cd apps/backend

./start.sh                          # ç®€å•å¯åŠ¨
./start-server.sh                   # å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼
./start-auth-server.sh              # å¸¦ç¯å¢ƒæ£€æŸ¥çš„å¯åŠ¨
```

### æ–¹å¼ä¸‰ï¼šPM2ç®¡ç†ï¼ˆç”Ÿäº§æ¨èï¼‰
```bash
cd apps/backend
pm2 start app.js --name "qimen-ai"
pm2 logs qimen-ai
pm2 restart qimen-ai
pm2 stop qimen-ai
```

## ğŸ¨ å‰ç«¯éƒ¨ç½²æ–¹å¼

### Vueå‰ç«¯éƒ¨ç½²
```bash
cd apps/frontend-vue

# å¼€å‘æ¨¡å¼
npm run dev                         # http://localhost:5173

# ç”Ÿäº§æ„å»º
npm run build                       # æ„å»ºåˆ° dist/ ç›®å½•
npm run preview                     # é¢„è§ˆæ„å»ºç»“æœ

# ç§»åŠ¨ç«¯æ„å»º
npm run build:mobile                # ç§»åŠ¨ç«¯ä¸“ç”¨æ„å»º
npx cap sync                        # åŒæ­¥åˆ°ç§»åŠ¨ç«¯
```

### Reactå‰ç«¯éƒ¨ç½²
```bash
cd apps/frontend-react

# å¼€å‘æ¨¡å¼
npm run dev                         # http://localhost:5174

# ç”Ÿäº§æ„å»º  
npm run build                       # æ„å»ºåˆ° dist/ ç›®å½•
npm run preview                     # é¢„è§ˆæ„å»ºç»“æœ

# ç§»åŠ¨ç«¯æ„å»º
npm run build:mobile                # ä½¿ç”¨ç§»åŠ¨ç«¯é…ç½®æ„å»º
npx cap sync                        # åŒæ­¥åˆ°ç§»åŠ¨ç«¯
```

## ğŸŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### æ ‡å‡†éƒ¨ç½²æµç¨‹
```bash
# ä½¿ç”¨é…ç½®ç›®å½•ä¸­çš„éƒ¨ç½²è„šæœ¬
./config/deploy.sh                  # æ ‡å‡†éƒ¨ç½²è„šæœ¬
./config/deploy-fix.sh              # ä¿®å¤ç‰ˆéƒ¨ç½²è„šæœ¬ï¼ˆå¦‚é‡å…¼å®¹æ€§é—®é¢˜ï¼‰
```

### æ‰‹åŠ¨ç”Ÿäº§éƒ¨ç½²
```bash
# 1. ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨
rsync -avz ./apps/backend/ root@101.201.148.8:/home/qimen-backend/
rsync -avz ./apps/frontend-vue/dist/ root@101.201.148.8:/home/qimen-frontend/vue/
rsync -avz ./apps/frontend-react/dist/ root@101.201.148.8:/home/qimen-frontend/react/

# 2. ç™»å½•æœåŠ¡å™¨
ssh root@101.201.148.8

# 3. åç«¯éƒ¨ç½²
cd /home/qimen-backend
npm install --production
npx prisma generate
npx prisma db push
pm2 start app.js --name "qimen-backend"

# 4. é…ç½®Nginx
# å‚è€ƒä¸‹æ–¹Nginxé…ç½®ç¤ºä¾‹
```

### Dockeréƒ¨ç½²
```bash
# ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•çš„Dockeré…ç½®
docker-compose -f config/docker-compose.yml up -d
```

## âš™ï¸ ç¯å¢ƒé…ç½®

### åç«¯ç¯å¢ƒå˜é‡
```bash
# apps/backend/.env (æˆ– config.env)
DATABASE_URL="file:./data/dev.db"
JWT_SECRET="your-jwt-secret-key"
PORT=3001
NODE_ENV=development

# ç”Ÿäº§ç¯å¢ƒ
NODE_ENV=production
DATABASE_URL="file:./data/prod.db"
AI_API_KEY="your-ai-api-key"
```

### Vueå‰ç«¯ç¯å¢ƒå˜é‡
```bash
# apps/frontend-vue/.env
VITE_API_BASE_URL=http://localhost:3001
VITE_APP_TITLE=ä¸æœªå¥‡é—¨éç”²

# apps/frontend-vue/.env.production
VITE_API_BASE_URL=http://101.201.148.8:3001
VITE_APP_TITLE=ä¸æœªå¥‡é—¨éç”²
```

### Reactå‰ç«¯ç¯å¢ƒå˜é‡
```bash
# apps/frontend-react/.env
VITE_API_BASE_URL=http://localhost:3001
VITE_FORCE_MOBILE_API=false

# apps/frontend-react/.env.production
VITE_API_BASE_URL=http://101.201.148.8:3001
VITE_FORCE_MOBILE_API=true
VITE_BUILD_TARGET=mobile
```

## ğŸŒ Nginxé…ç½®

### å®Œæ•´Nginxé…ç½®ç¤ºä¾‹
```nginx
server {
    listen 80;
    server_name qimen.example.com;

    # åç«¯APIä»£ç†
    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Vueå‰ç«¯
    location /vue {
        alias /home/qimen-frontend/vue;
        try_files $uri $uri/ /vue/index.html;
        
        # é™æ€èµ„æºç¼“å­˜
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # Reactå‰ç«¯
    location /react {
        alias /home/qimen-frontend/react;
        try_files $uri $uri/ /react/index.html;
        
        # é™æ€èµ„æºç¼“å­˜
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # é»˜è®¤é‡å®šå‘åˆ°Vueç‰ˆæœ¬
    location / {
        return 301 /vue/;
    }

    # å¥åº·æ£€æŸ¥
    location /health {
        proxy_pass http://localhost:3001/health;
    }
}
```

## ğŸ“± ç§»åŠ¨ç«¯éƒ¨ç½²

### Vueå‰ç«¯ç§»åŠ¨ç«¯
```bash
cd apps/frontend-vue

# iOSéƒ¨ç½²
npm run build:mobile
npx cap sync ios
npx cap open ios                    # åœ¨Xcodeä¸­æ„å»ºå’Œå‘å¸ƒ

# Androidéƒ¨ç½²
npm run build:mobile
npx cap sync android
npx cap open android                # åœ¨Android Studioä¸­æ„å»ºå’Œå‘å¸ƒ
```

### Reactå‰ç«¯ç§»åŠ¨ç«¯
```bash
cd apps/frontend-react

# ç§»åŠ¨ç«¯æ„å»º
npm run build:mobile                # ä½¿ç”¨ç§»åŠ¨ç«¯ä¸“ç”¨é…ç½®

# iOSéƒ¨ç½²
npx cap sync ios
npx cap open ios

# Androidéƒ¨ç½²
npx cap sync android
npx cap open android
```

### ç§»åŠ¨ç«¯é…ç½®è¦ç‚¹
- Vueå‰ç«¯ä½¿ç”¨Capacitor 7.xï¼ŒåŒ…åï¼š`com.guiguqimen.app.1750352961`
- Reactå‰ç«¯ä½¿ç”¨Capacitor 6.xï¼ŒåŒ…åï¼š`com.guiguqimen.react.app`
- ç§»åŠ¨ç«¯è‡ªåŠ¨ä½¿ç”¨æœåŠ¡å™¨APIåœ°å€ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®

## ğŸ” æœåŠ¡ç›‘æ§

### PM2è¿›ç¨‹ç®¡ç†
```bash
# æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹
pm2 list

# æŸ¥çœ‹æ—¥å¿—
pm2 logs qimen-backend

# é‡å¯æœåŠ¡
pm2 restart qimen-backend

# æŸ¥çœ‹è¿›ç¨‹è¯¦æƒ…
pm2 show qimen-backend

# ç›‘æ§é¢æ¿
pm2 monit
```

### å¥åº·æ£€æŸ¥
```bash
# åç«¯å¥åº·æ£€æŸ¥
curl http://localhost:3001/health

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
curl http://localhost:3001/api/health/db

# æ£€æŸ¥AIæœåŠ¡
curl http://localhost:3001/api/health/ai
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. åç«¯å¯åŠ¨å¤±è´¥
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :3001

# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™
ls -la apps/backend/data/

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
cd apps/backend && NODE_ENV=development node app.js
```

#### 2. å‰ç«¯æ„å»ºå¤±è´¥
```bash
# æ¸…ç†ä¾èµ–é‡è£…
cd apps/frontend-vue
rm -rf node_modules package-lock.json
npm install

# æ£€æŸ¥Nodeç‰ˆæœ¬ï¼ˆæ¨è18+ï¼‰
node --version
npm --version
```

#### 3. APIè°ƒç”¨å¤±è´¥
```bash
# æ£€æŸ¥Nginxä»£ç†é…ç½®
nginx -t
systemctl reload nginx

# æ£€æŸ¥åç«¯APIæ˜¯å¦æ­£å¸¸
curl -I http://localhost:3001/api/health
```

#### 4. ç§»åŠ¨ç«¯æ„å»ºé—®é¢˜
```bash
# é‡æ–°åŒæ­¥Capacitor
cd apps/frontend-vue
npx cap sync
npx cap doctor                      # æ£€æŸ¥ç¯å¢ƒé…ç½®

# æ¸…ç†Capacitorç¼“å­˜
npx cap clean
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### åç«¯ä¼˜åŒ–
- ä½¿ç”¨PM2é›†ç¾¤æ¨¡å¼ï¼š`pm2 start app.js -i max`
- å¯ç”¨æ•°æ®åº“è¿æ¥æ± 
- é…ç½®Redisç¼“å­˜ï¼ˆå¯é€‰ï¼‰
- ä½¿ç”¨Nginxè´Ÿè½½å‡è¡¡

### å‰ç«¯ä¼˜åŒ–
- å¯ç”¨Gzipå‹ç¼©ï¼š`gzip on;` in Nginx
- é…ç½®CDNåŠ é€Ÿé™æ€èµ„æº
- å¯ç”¨æµè§ˆå™¨ç¼“å­˜
- ä½¿ç”¨Webpack Bundle Analyzeråˆ†æåŒ…å¤§å°

### æ•°æ®åº“ä¼˜åŒ–
```bash
# SQLiteæ€§èƒ½ä¼˜åŒ–
cd apps/backend
sqlite3 data/prod.db "PRAGMA optimize;"
sqlite3 data/prod.db "VACUUM;"
```

## ğŸ” å®‰å…¨é…ç½®

### SSLè¯ä¹¦é…ç½®
```nginx
server {
    listen 443 ssl http2;
    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;
    
    # SSLå®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
}
```

### é˜²ç«å¢™é…ç½®
```bash
# åªå¼€æ”¾å¿…è¦ç«¯å£
ufw allow 22                        # SSH
ufw allow 80                        # HTTP
ufw allow 443                       # HTTPS
ufw deny 3001                       # ç¦æ­¢ç›´æ¥è®¿é—®åç«¯ç«¯å£
ufw enable
```

## ğŸ“ éƒ¨ç½²æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥
- [ ] ä»£ç å·²æäº¤åˆ°Git
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] æ•°æ®åº“è¿ç§»å·²å®Œæˆ
- [ ] SSLè¯ä¹¦å·²å®‰è£…
- [ ] åŸŸåDNSå·²è§£æ

### éƒ¨ç½²åéªŒè¯
- [ ] åç«¯APIå¯æ­£å¸¸è®¿é—®
- [ ] Vueå‰ç«¯é¡µé¢æ­£å¸¸æ˜¾ç¤º
- [ ] Reactå‰ç«¯é¡µé¢æ­£å¸¸æ˜¾ç¤º
- [ ] ç”¨æˆ·æ³¨å†Œç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] å¥‡é—¨éç”²æ’ç›˜åŠŸèƒ½æ­£å¸¸
- [ ] AIåˆ†æåŠŸèƒ½æ­£å¸¸
- [ ] ç§»åŠ¨ç«¯åº”ç”¨æ­£å¸¸è¿è¡Œ

---

## ğŸ¯ å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# å¼€å‘ç¯å¢ƒ
./start-dev.sh start

# ç”Ÿäº§éƒ¨ç½²
./config/deploy.sh

# åç«¯ç®¡ç†
cd apps/backend && pm2 restart app.js

# å‰ç«¯æ„å»º
cd apps/frontend-vue && npm run build
cd apps/frontend-react && npm run build

# ç§»åŠ¨ç«¯æ„å»º
cd apps/frontend-vue && npm run build:mobile
cd apps/frontend-react && npm run build:mobile
```


- **æ–‡æ¡£**: æŸ¥çœ‹ [README.md](mdc:backend/README.md) å’Œ [AUTH_SYSTEM_README.md](mdc:backend/AUTH_SYSTEM_README.md)
- **æ—¥å¿—**: æŸ¥çœ‹ç›¸åº”çš„æ—¥å¿—æ–‡ä»¶è¿›è¡Œé—®é¢˜è¯Šæ–­
- **ç›‘æ§**: ä½¿ç”¨å¥åº·æ£€æŸ¥æ¥å£ç›‘æ§æœåŠ¡çŠ¶æ€
