# ä¸æœªå¥‡é—¨éç”²ç³»ç»Ÿ - APIæ¥å£è§„åˆ™ (2024ä¼˜åŒ–ç‰ˆ)

## ğŸŒ APIç«¯ç‚¹æ€»è§ˆ

ç³»ç»Ÿæä¾›å®Œæ•´çš„RESTful APIï¼Œæ‰€æœ‰æ¥å£é€šè¿‡ [apps/backend/app.js](mdc:apps/backend/app.js) ç»Ÿä¸€å¤„ç†ã€‚

### ğŸ”— åŸºç¡€URL
- **å¼€å‘ç¯å¢ƒ**: `http://localhost:3001`
- **ç”Ÿäº§ç¯å¢ƒ**: `http://101.201.148.8:3001`
- **Vueå‰ç«¯ä»£ç†**: `http://localhost:5173/api` (é€šè¿‡Viteä»£ç†)
- **Reactå‰ç«¯ä»£ç†**: `http://localhost:5174/api` (é€šè¿‡Viteä»£ç†)

### ğŸ—ï¸ APIæ¶æ„è¯´æ˜
- **ç»Ÿä¸€å…¥å£**: æ‰€æœ‰APIè¯·æ±‚é€šè¿‡ [apps/backend/app.js](mdc:apps/backend/app.js) å¤„ç†
- **æ¨¡å—åŒ–è·¯ç”±**: è·¯ç”±æ¨¡å—ä½äº [apps/backend/src/routes/](mdc:apps/backend/src/routes/) ç›®å½•
- **ä¸­é—´ä»¶**: è®¤è¯å’Œé™æµé€šè¿‡ [apps/backend/src/middleware/](mdc:apps/backend/src/middleware/) ç»Ÿä¸€ç®¡ç†
- **æœåŠ¡å±‚**: ä¸šåŠ¡é€»è¾‘åœ¨ [apps/backend/src/services/](mdc:apps/backend/src/services/) ä¸­å®ç°

## ğŸ” è®¤è¯ç³»ç»Ÿæ¥å£

### ç”¨æˆ·æ³¨å†Œ
```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "testuser",
  "email": "test@example.com",
  "password": "123456",
  "phone": "13800138000",     // å¯é€‰
  "inviteCode": "INVITE123"   // å¯é€‰ï¼Œé‚€è¯·ç æ³¨å†Œ
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "æ³¨å†ŒæˆåŠŸ",
  "data": {
    "user": {
      "id": "user_123",
      "username": "testuser",
      "email": "test@example.com"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

### ç”¨æˆ·ç™»å½•
```http
POST /api/auth/login
Content-Type: application/json

{
  "usernameOrEmail": "testuser",
  "password": "123456"
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "user": {
      "id": "user_123",
      "username": "testuser",
      "points": 100
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

### è·å–ç”¨æˆ·èµ„æ–™
```http
GET /api/auth/profile
Authorization: Bearer <JWT_TOKEN>
```

### ç”¨æˆ·ç™»å‡º
```http
POST /api/auth/logout
Authorization: Bearer <JWT_TOKEN>
```

## ğŸ’° ç§¯åˆ†ç³»ç»Ÿæ¥å£

### è·å–ç§¯åˆ†ä¿¡æ¯
```http
GET /api/points
Authorization: Bearer <JWT_TOKEN>
```

### ç§¯åˆ†äº¤æ˜“è®°å½•
```http
GET /api/points/transactions
Authorization: Bearer <JWT_TOKEN>
```

### æ‰§è¡Œç§¯åˆ†æ¶ˆè´¹ (ç³»ç»Ÿå†…éƒ¨)
```http
POST /api/points/consume
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "amount": 10,
  "reason": "AIåˆ†ææ¶ˆè´¹"
}
```

## âœ… ç­¾åˆ°ç³»ç»Ÿæ¥å£

### è·å–ç­¾åˆ°çŠ¶æ€
```http
GET /api/checkin/status
Authorization: Bearer <JWT_TOKEN>
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "hasCheckedIn": false,
    "consecutiveDays": 5,
    "totalCheckins": 30,
    "nextReward": 10
  }
}
```

### æ‰§è¡Œç­¾åˆ°
```http
POST /api/checkin
Authorization: Bearer <JWT_TOKEN>
```

## ğŸ”® å¥‡é—¨éç”²æ¥å£

### å¥‡é—¨éç”²æ’ç›˜
```http
POST /api/qimen/paipan
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "question": "äº‹ä¸šå‘å±•å¦‚ä½•ï¼Ÿ",
  "category": "äº‹ä¸š",
  "datetime": "2024-08-03T10:30:00.000Z",  // å¯é€‰ï¼Œé»˜è®¤å½“å‰æ—¶é—´
  "location": {                            // å¯é€‰ï¼Œé»˜è®¤åŒ—äº¬
    "longitude": 116.4074,
    "latitude": 39.9042
  }
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "paipanData": {
      "year": "ç”²è¾°",
      "month": "å£¬ç”³",
      "day": "è¾›å¯",
      "hour": "ç™¸å·³",
      "ju": "é˜³éäº”å±€",
      "zhifu": "å¤©å¿ƒ",
      "zhishi": "å¼€é—¨"
    },
    "question": "äº‹ä¸šå‘å±•å¦‚ä½•ï¼Ÿ",
    "category": "äº‹ä¸š",
    "timestamp": "2024-08-03T10:30:00.000Z"
  }
}
```

### AIæ™ºèƒ½åˆ†æ - ç®€å•æ¨¡å¼
```http
POST /api/analysis/qimen
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "question": "äº‹ä¸šå‘å±•å¦‚ä½•ï¼Ÿ",
  "paipanData": { /* æ’ç›˜æ•°æ® */ },
  "mode": "simple"
}
```

### AIæ™ºèƒ½åˆ†æ - è¯¦ç»†æ¨¡å¼
```http
POST /api/analysis/qimen
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "question": "äº‹ä¸šå‘å±•å¦‚ä½•ï¼Ÿ",
  "paipanData": { /* æ’ç›˜æ•°æ® */ },
  "mode": "detailed"
}
```

### AIæ™ºèƒ½åˆ†æ - æµå¼æ¨¡å¼
```http
POST /api/analysis/qimen/stream
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "question": "äº‹ä¸šå‘å±•å¦‚ä½•ï¼Ÿ",
  "paipanData": { /* æ’ç›˜æ•°æ® */ }
}
```

**æµå¼å“åº”**: è¿”å› `text/event-stream` æ ¼å¼çš„å®æ—¶æ•°æ®æµ

## ğŸ“š å†å²è®°å½•æ¥å£

### è·å–å†å²è®°å½•åˆ—è¡¨
```http
GET /api/qimen/history?page=1&limit=20&search=å…³é”®è¯
Authorization: Bearer <JWT_TOKEN>
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "records": [
      {
        "id": "record_123",
        "question": "äº‹ä¸šå‘å±•å¦‚ä½•ï¼Ÿ",
        "analysis": "åˆ†æç»“æœæ‘˜è¦...",
        "tags": "äº‹ä¸š,å‘å±•",
        "createdAt": "2024-08-03T10:30:00.000Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 50,
      "hasNext": true
    }
  }
}
```

### è·å–å†å²è®°å½•è¯¦æƒ…
```http
GET /api/qimen/history/:id
Authorization: Bearer <JWT_TOKEN>
```

### åˆ é™¤å†å²è®°å½•
```http
DELETE /api/qimen/history/:id
Authorization: Bearer <JWT_TOKEN>
```

## â­ æ”¶è—å¤¹æ¥å£

### è·å–æ”¶è—åˆ—è¡¨
```http
GET /api/qimen/favorites?page=1&limit=20
Authorization: Bearer <JWT_TOKEN>
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "favorites": [
      {
        "id": "fav_123",
        "recordId": "record_123",
        "note": "é‡è¦çš„äº‹ä¸šåˆ†æ",
        "createdAt": "2024-08-03T11:00:00.000Z",
        "record": {
          "question": "äº‹ä¸šå‘å±•å¦‚ä½•ï¼Ÿ",
          "analysis": "åˆ†æç»“æœ...",
          "paipanData": { /* æ’ç›˜æ•°æ® */ }
        }
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 10
    }
  }
}
```

### æ·»åŠ æ”¶è—
```http
POST /api/qimen/favorites
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "recordId": "record_123",
  "note": "é‡è¦çš„äº‹ä¸šåˆ†æ"
}
```

### æ›´æ–°æ”¶è—å¤‡æ³¨
```http
PUT /api/qimen/favorites/:recordId
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "note": "æ›´æ–°åçš„å¤‡æ³¨å†…å®¹"
}
```

### å–æ¶ˆæ”¶è—
```http
DELETE /api/qimen/favorites/:recordId
Authorization: Bearer <JWT_TOKEN>
```

## ğŸ« é‚€è¯·ç ç³»ç»Ÿæ¥å£

### ç”Ÿæˆé‚€è¯·ç  (ç®¡ç†å‘˜)
```http
POST /api/invite-codes/generate
Authorization: Bearer <ADMIN_JWT_TOKEN>
Content-Type: application/json

{
  "count": 10,
  "description": "æ¨å¹¿æ´»åŠ¨é‚€è¯·ç "
}
```

### éªŒè¯é‚€è¯·ç 
```http
POST /api/invite-codes/validate
Content-Type: application/json

{
  "code": "INVITE123"
}
```

### è·å–é‚€è¯·ç åˆ—è¡¨ (ç®¡ç†å‘˜)
```http
GET /api/invite-codes?page=1&limit=20&status=unused
Authorization: Bearer <ADMIN_JWT_TOKEN>
```

## ğŸ¥ å¥åº·æ£€æŸ¥æ¥å£

### ç³»ç»Ÿå¥åº·æ£€æŸ¥
```http
GET /health
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "status": "healthy",
  "timestamp": "2024-08-03T10:30:00.000Z",
  "uptime": 3600,
  "version": "1.0.0"
}
```

### æ•°æ®åº“å¥åº·æ£€æŸ¥
```http
GET /api/health/db
Authorization: Bearer <JWT_TOKEN>
```

### AIæœåŠ¡å¥åº·æ£€æŸ¥
```http
GET /api/health/ai
Authorization: Bearer <JWT_TOKEN>
```

## ğŸ”§ MCPæœåŠ¡æ¥å£ (å†…éƒ¨)

### MCPå·¥å…·è°ƒç”¨
```http
POST /api/mcp/tools/call
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "toolName": "qimen_analysis",
  "arguments": {
    "question": "äº‹ä¸šå‘å±•å¦‚ä½•ï¼Ÿ",
    "paipanData": { /* æ’ç›˜æ•°æ® */ }
  }
}
```

## ğŸ“Š APIé”™è¯¯å¤„ç†

### æ ‡å‡†é”™è¯¯å“åº”æ ¼å¼
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "è¾“å…¥å‚æ•°éªŒè¯å¤±è´¥",
    "details": {
      "field": "username",
      "reason": "ç”¨æˆ·åå·²å­˜åœ¨"
    }
  },
  "timestamp": "2024-08-03T10:30:00.000Z"
}
```

### å¸¸è§é”™è¯¯ç 
- `VALIDATION_ERROR`: è¾“å…¥éªŒè¯å¤±è´¥
- `UNAUTHORIZED`: æœªæˆæƒè®¿é—®
- `FORBIDDEN`: æƒé™ä¸è¶³
- `NOT_FOUND`: èµ„æºä¸å­˜åœ¨
- `RATE_LIMITED`: è¯·æ±‚é¢‘ç‡é™åˆ¶
- `INSUFFICIENT_POINTS`: ç§¯åˆ†ä¸è¶³
- `AI_SERVICE_ERROR`: AIæœåŠ¡é”™è¯¯
- `DATABASE_ERROR`: æ•°æ®åº“é”™è¯¯

## ğŸ›¡ï¸ APIå®‰å…¨æœºåˆ¶

### JWTè®¤è¯
- **è®¤è¯å¤´**: `Authorization: Bearer <token>`
- **è¿‡æœŸæ—¶é—´**: 7å¤©
- **åˆ·æ–°æœºåˆ¶**: é‡æ–°ç™»å½•è·å–æ–°token

### é™æµç­–ç•¥
- **é€šç”¨API**: 100æ¬¡/åˆ†é’Ÿ
- **AIåˆ†æ**: 10æ¬¡/åˆ†é’Ÿ
- **æ³¨å†Œç™»å½•**: 5æ¬¡/åˆ†é’Ÿ
- **æ–‡ä»¶ä¸Šä¼ **: 20æ¬¡/å°æ—¶

### è¾“å…¥éªŒè¯
- æ‰€æœ‰æ¥å£ä½¿ç”¨Joi schemaéªŒè¯
- SQLæ³¨å…¥é˜²æŠ¤ (Prisma ORM)
- XSSæ”»å‡»é˜²æŠ¤
- CSRFä¿æŠ¤

## ğŸ” APIæµ‹è¯•ç¤ºä¾‹

### ä½¿ç”¨curlæµ‹è¯•
```bash
# ç”¨æˆ·æ³¨å†Œ
curl -X POST http://localhost:3001/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","email":"test@example.com","password":"123456"}'

# ç”¨æˆ·ç™»å½•
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"usernameOrEmail":"testuser","password":"123456"}'

# å¥‡é—¨éç”²æ’ç›˜ (éœ€è¦token)
curl -X POST http://localhost:3001/api/qimen/paipan \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"question":"äº‹ä¸šå‘å±•å¦‚ä½•ï¼Ÿ","category":"äº‹ä¸š"}'

# è·å–å†å²è®°å½•
curl -X GET "http://localhost:3001/api/qimen/history?page=1&limit=10" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### å‰ç«¯APIè°ƒç”¨ç¤ºä¾‹ (Vue)
```javascript
// apps/frontend-vue/src/utils/qimenApi.js
import { apiClient } from './api.js';

// å¥‡é—¨æ’ç›˜
export const qimenPaipan = async (question, category) => {
  const response = await apiClient.post('/api/qimen/paipan', {
    question,
    category
  });
  return response.data;
};

// AIåˆ†æ
export const qimenAnalysis = async (question, paipanData, mode = 'simple') => {
  const response = await apiClient.post('/api/analysis/qimen', {
    question,
    paipanData,
    mode
  });
  return response.data;
};

// è·å–å†å²è®°å½•
export const getHistory = async (page = 1, limit = 20, search = '') => {
  const response = await apiClient.get('/api/qimen/history', {
    params: { page, limit, search }
  });
  return response.data;
};
```

### å‰ç«¯APIè°ƒç”¨ç¤ºä¾‹ (React)
```javascript
// apps/frontend-react/src/services/api.js
import axios from 'axios';

// é…ç½®APIå®¢æˆ·ç«¯
const apiClient = axios.create({
  baseURL: process.env.NODE_ENV === 'production' 
    ? 'http://101.201.148.8:3001' 
    : '/api',
  timeout: 30000
});

// æ·»åŠ æ”¶è—
export const addFavorite = async (recordId, note = '') => {
  const response = await apiClient.post('/api/qimen/favorites', {
    recordId,
    note
  });
  return response.data;
};

// è·å–æ”¶è—åˆ—è¡¨
export const getFavorites = async (page = 1, limit = 20) => {
  const response = await apiClient.get('/api/qimen/favorites', {
    params: { page, limit }
  });
  return response.data;
};
```

## ğŸ“ˆ APIæ€§èƒ½ç›‘æ§

### å“åº”æ—¶é—´åŸºå‡†
- **è®¤è¯æ¥å£**: < 200ms
- **å¥‡é—¨æ’ç›˜**: < 500ms
- **ç®€å•AIåˆ†æ**: < 3s
- **è¯¦ç»†AIåˆ†æ**: < 10s
- **æ•°æ®æŸ¥è¯¢**: < 100ms

### ç›‘æ§æŒ‡æ ‡
- è¯·æ±‚é‡ (QPS)
- å“åº”æ—¶é—´ (RT)
- é”™è¯¯ç‡ (Error Rate)
- å¯ç”¨æ€§ (Availability)

### æ—¥å¿—æ ¼å¼
```json
{
  "timestamp": "2024-08-03T10:30:00.000Z",
  "method": "POST",
  "url": "/api/qimen/paipan",
  "userId": "user_123",
  "duration": 456,
  "status": 200,
  "userAgent": "Mozilla/5.0..."
}
```

---

## ğŸ“‹ APIå¼€å‘è§„èŒƒ

### æ¥å£å‘½åè§„èŒƒ
- ä½¿ç”¨RESTfulé£æ ¼
- èµ„æºåä½¿ç”¨å¤æ•°å½¢å¼
- åŠ¨ä½œä½¿ç”¨HTTPåŠ¨è¯è¡¨ç¤º
- åµŒå¥—èµ„æºä¸è¶…è¿‡3å±‚

### å“åº”æ ¼å¼è§„èŒƒ
- ç»Ÿä¸€ä½¿ç”¨ `{ success, data, error }` æ ¼å¼
- åˆ†é¡µä½¿ç”¨ `pagination` å¯¹è±¡
- æ—¶é—´ç»Ÿä¸€ä½¿ç”¨ISO 8601æ ¼å¼
- é”™è¯¯ä¿¡æ¯æä¾›è¯¦ç»†çš„é”™è¯¯ç å’Œæè¿°

### æ–°æ¥å£å¼€å‘æµç¨‹
1. åœ¨ [apps/backend/src/routes/](mdc:apps/backend/src/routes/) ä¸­æ·»åŠ è·¯ç”±
2. åœ¨ [apps/backend/src/services/](mdc:apps/backend/src/services/) ä¸­å®ç°ä¸šåŠ¡é€»è¾‘  
3. æ›´æ–°æœ¬æ–‡æ¡£ä¸­çš„æ¥å£è¯´æ˜
4. ç¼–å†™æ¥å£æµ‹è¯•ç”¨ä¾‹
5. æ›´æ–°å‰ç«¯APIå®¢æˆ·ç«¯ä»£ç 


## ğŸ“ æµ‹è¯•ç”¨ä¾‹

å‚è€ƒ [backend/AUTH_SYSTEM_README.md](mdc:backend/AUTH_SYSTEM_README.md) ä¸­çš„æµ‹è¯•ç¤ºä¾‹ã€‚
