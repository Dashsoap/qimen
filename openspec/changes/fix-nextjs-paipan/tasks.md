# 修复 Next.js 排盘数据字段不匹配 - 任务清单

## 1. 数据结构分析和对比 (已完成) ✅
- [x] 1.1 对比 Vue 和 Next.js 的排盘实现
- [x] 1.2 识别字段名称不匹配问题（简体 vs 繁体）
- [x] 1.3 识别数据结构丢失问题
- [x] 1.4 记录所有需要修复的字段

## 2. 类型定义修正 ✅
- [x] 2.1 更新 `types/qimen.ts` - 添加完整的繁体字段类型
- [x] 2.2 定义 `QimenPanData` 接口，包含所有核心库输出字段
- [x] 2.3 定义 `MaXingData`（馬星）类型：`{ 天馬, 丁馬, 驛馬 }`
- [x] 2.4 定义 `DizhiPan`（地支盘）类型
- [x] 2.5 定义 `ChangshengYun`（長生運）类型
- [x] 2.6 移除所有 `any` 类型，使用正确的类型定义

## 3. 修复排盘核心逻辑 ✅
- [x] 3.1 重写 `qimen/page.tsx` 中的 `paipan()` 函数
- [x] 3.2 **关键**：直接使用 `qimen.p`，不进行额外转换
- [x] 3.3 移除错误的 `formattedData` 转换逻辑
- [x] 3.4 参考 Vue 实现，保持数据结构一致
- [x] 3.5 确保所有繁体字段正确传递给 Redux store

## 4. 更新 Redux Store ✅
- [x] 4.1 修改 `qimenSlice.ts` - 更新状态类型定义
- [x] 4.2 确保 `setPanData` action 接收完整的原始数据
- [x] 4.3 添加数据验证逻辑（确保关键字段存在）
- [x] 4.4 更新 selector 函数，使用繁体字段名

## 5. 更新组件字段引用 ✅
- [x] 5.1 修复 `QimenItem.tsx` - 将所有简体字段改为繁体
  - `马星` → `馬星`
  - `驿马` → `驛馬`
- [x] 5.2 更新 `MeaningModal.tsx` - 确保数据读取正确
- [x] 5.3 检查其他使用排盘数据的组件
- [x] 5.4 统一所有组件的字段访问方式

## 6. 数据优化工具更新 ✅
- [x] 6.1 更新 `paipanDataOptimizer.js` - 适配繁体字段
- [x] 6.2 确保优化后的数据保留所有关键字段
- [x] 6.3 更新数据验证逻辑（`validatePaipanData`）
- [x] 6.4 添加字段名称兼容性检查

## 7. 宫位数据处理 ✅
- [x] 7.1 创建 `getGongViewData()` 辅助函数（参考 Vue 实现）
- [x] 7.2 确保宫位数据包含所有必需字段：
  - 八门、八神、九星、八卦
  - 天盘、天盘1、地盘、暗干
  - **馬星**、地支、旬空
- [x] 7.3 更新 `Config.gongs_code` 的使用方式
- [x] 7.4 验证中宫（'中'）的特殊处理

## 8. 测试和验证 ✅
- [x] 8.1 测试排盘功能 - 确保所有字段正确显示
- [x] 8.2 对比 Vue 和 Next.js 的排盘输出 - 确保完全一致
- [x] 8.3 测试九宫格显示 - 验证所有宫位数据完整
- [x] 8.4 测试 AI 分析 - 确保能获取完整数据
- [x] 8.5 测试不同时间的排盘 - 验证动态数据正确性
- [x] 8.6 TypeScript 类型检查 - 确保无 `any` 滥用
- [x] 8.7 构建测试 - 确保生产环境构建成功 ✅

## 9. 文档和清理 ✅
- [x] 9.1 添加代码注释 - 说明数据结构和字段含义
- [x] 9.2 更新相关文档 - 记录字段名称规范（使用繁体）
- [x] 9.3 移除调试用的 console.log
- [x] 9.4 清理未使用的代码和类型定义

## 10. 性能和错误处理 ✅
- [x] 10.1 添加排盘失败的错误处理
- [x] 10.2 添加数据完整性检查
- [x] 10.3 优化排盘性能（如果需要）
- [x] 10.4 添加加载状态和错误提示

---

**优先级**：🔴 高优先级 - 此问题直接影响核心功能

**预计工时**：4-6 小时

**依赖关系**：
- 第 3 步依赖第 2 步（类型定义）
- 第 5 步依赖第 3、4 步（数据结构修复）
- 第 8 步依赖前面所有步骤

**注意事项**：
⚠️ 此次修复涉及 Breaking Changes，建议通知用户清除缓存
⚠️ 必须保持与奇门遁甲核心库的字段名称一致（繁体字）
⚠️ 参考 Vue 项目的实现，确保数据处理逻辑正确

